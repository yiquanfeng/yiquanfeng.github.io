+++
date = '2025-08-20T23:47:03+08:00'
draft = false
title = '运维工具1--ssh'
+++
> 这篇文章借助了gemini，gemini对于ssh的理解感觉很深了，我基本就是复述
>和实操，加了一点自己使用ssh的经验
# a protocol to connect to remote server
## ssh出现的原因（imp）
在ssh出现之前，旧协议telnet，ftp，rlogin使用的都是明文传输内容十分不安全，不过他们至少解决了远程主机认证的问题。  
因此我们可以知道，ssh解决了两个核心问题。  
第一是远程主机认证和用户身份认证  
第二是交互数据的加密问题，确保传输的数据不被别人窃听  
### 关于ssh的连接过程（面试题）
ssh的连接主要分为三个主要阶段  
第一个阶段，client向server发起连接请求，然后server返回它能够支持的ssh协议的版本等信息,之后两者协商出一套能够互相支持的算法列表(加密算法、mac算法等)  
第二个阶段是，server先将自己的公钥传给client,收到公钥之后，client会首先根据服务器的ip检查自己是否保存过这个服务器的公钥，如果没有保存过，则就是第一次连接，第一次连接，会提示是否信任并且添加密钥。如果保存过，则不是第一次连接，则会检查收到的公钥和之前存储的密钥一不一致，如果一致则顺利进行，如果不一致，ssh工具会拒绝连接，因为很可能这次连接被监听了  
> 实际上，有时候我们的电脑重装了系统，但是连接网络的ip池稳定，那么就会出现相同ip，而不同公钥的情况，这时候，就需要清楚know_host文件中的对应数据，重置一下状态

最后一个阶段就是用户认证,关于用户认证，有两种方式。
第一种方式比较简单，就是密码认证，直接校验密码是否匹配即可。  
第二种方式是比较实用的，就是密钥认证。client使用ssh-keygen生成自己的私钥和公钥，然后将公钥提前存在服务器中，当服务器接到连接请求，并收到所使用的公钥之后，会使用存放的公钥加密一段随机的数字串，然后把加密的数据发给client，client使用私钥解密之后将原始数字串发回去，服务器验证通过之后即可顺利连接


## ssh常用命令
可以使用下面的命令生成ssh密钥  
```
ssh-keygen -t rsa  -C "xxx@mail.com"
```  
你的公钥私钥文件都会在 ~/.ssh/ 下面  
然后你可以以下命令将本机的公钥传给远程主机  
``` bash
ssh-copy-id username@ip
```
然后你就可以使用密钥而无需密码来登陆远程主机了 

ssh '' 远程仅执行命令后立马退出  
ssh
    -L 本地端口转发，将本机的端口给远程用，如果需要安全的代理服务可以使用
    -R 远程端口转发，将远程的端口给本机用，适合想把本机的服务临时暴露公网
```
ssh —L 8080:localhost:80
将本机8080端口的流量传到远程主机的80端口中,相当于pull，让远程主机可以访问本地内容，
ssh -R 8080:localhost:80
将远程主机8080端口的流量传输到本机的80端口，相当于push，如果本机8080端口部署了web，那么有人访问了远程主机的8080端口，那么就会重定向到本机的80端口的服务
```
scp远程一次性传输文件， -r选项传输文件夹  
sftp  
    get可以将目标主机上的文件放到sftp开启的目录下  
    put可以将相对sftp开启的目录下的文件传到远程主机上  
ssh-agent and ssh-add  

## 服务器暴露公网之后，如何加固ssh服务的安全性
1.禁用root用户登陆  
PermitRootLogin no  
2.仅允许密钥认证  
PasswordAuthentication no  
PubkeyAuthentication yes  
3.采用非常规端口  
Port 19191  
4.限制登陆用户  
5.使用fail2ban工具，检测有无暴力破解  

## the difference of ssh and sshd
ssh_config配置文件在linux服务器中，配置的是本身连接其他远程主机的行为
sshd_config配置文件在linux服务器中，配置的是别人连接自己时候的验证配置，并且存在sshd service，因为它需要常驻后台